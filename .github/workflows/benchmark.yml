name: Benchmark

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # For commenting on PRs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            crates/convert-buddy/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli --version 0.2.99

      - name: Install dependencies
        run: npm ci

      - name: Build WASM and TypeScript
        run: |
          cd packages/convert-buddy-js
          npm run build

      - name: Run benchmarks
        run: |
          cd packages/convert-buddy-js
          npm run bench -- --json
        env:
          UV_THREADPOOL_SIZE: 4
          NODE_OPTIONS: --expose-gc

      - name: Download baseline (for PRs)
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: benchmark.yml
          branch: main
          name: benchmark-results
          path: packages/convert-buddy-js/baseline
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Compare against baseline (PR only)
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          cd packages/convert-buddy-js
          
          if [ -f baseline/bench-results.json ]; then
            echo "Comparing against baseline from main branch"
            node dist/bench/compare-benchmarks.js \
              --current bench-results.json \
              --baseline baseline/bench-results.json \
              --output-comment || echo "regression_detected=true" >> $GITHUB_OUTPUT
          else
            echo "No baseline found, checking against performance targets"
            node dist/bench/compare-benchmarks.js \
              --current bench-results.json \
              --check-targets \
              --output-comment || echo "regression_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Post benchmark comment (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentPath = 'packages/convert-buddy-js/benchmark-comment.md';
            
            if (fs.existsSync(commentPath)) {
              const comment = fs.readFileSync(commentPath, 'utf8');
              
              // Find existing benchmark comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Benchmark Results')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
              }
            }

      - name: Check for regressions (PR only)
        if: github.event_name == 'pull_request' && steps.compare.outputs.regression_detected == 'true'
        run: |
          echo "::error::Performance regression detected! See benchmark comment for details."
          exit 1

      - name: Upload benchmark results as artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            packages/convert-buddy-js/bench-results.json
            packages/convert-buddy-js/bench/performance-baselines.json
          retention-days: 90

      - name: Archive benchmark results (all runs)
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: packages/convert-buddy-js/bench-results.json
          retention-days: 30
