{"version":3,"sources":["../src/index.ts"],"sourcesContent":["export type ConvertBuddyOptions = {\r\n  debug?: boolean;\r\n};\r\n\r\ntype WasmModule = {\r\n  default?: unknown;\r\n  init: (debugEnabled: boolean) => void;\r\n  Converter: new (debug: boolean) => {\r\n    push: (chunk: Uint8Array) => Uint8Array;\r\n    finish: () => Uint8Array;\r\n  };\r\n};\r\n\r\nasync function loadWasmModule(): Promise<WasmModule> {\r\n  // Heuristic: Cloudflare Workers and browsers have `WebAssembly` + `fetch` and no `process.versions.node`.\r\n  const isNode =\r\n    typeof process !== \"undefined\" &&\r\n    !!(process as any).versions?.node;\r\n\r\n  if (isNode) {\r\n    // Load the CJS shim from ESM using createRequire\r\n    const { createRequire } = await import(\"node:module\");\r\n    const require = createRequire(import.meta.url);\r\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n    const mod = require(\"../wasm-node.cjs\");\r\n    return mod as WasmModule;\r\n  }\r\n\r\n  // Web/Worker path\r\n  const mod = (await import(\"../wasm/web/convert_buddy.js\")) as unknown as WasmModule;\r\n  return mod;\r\n}\r\n\r\nexport class ConvertBuddy {\r\n  private converter: any;\r\n  private debug: boolean;\r\n\r\n  private constructor(converter: any, debug: boolean) {\r\n    this.converter = converter;\r\n    this.debug = debug;\r\n  }\r\n\r\n  static async create(opts: ConvertBuddyOptions = {}): Promise<ConvertBuddy> {\r\n    const debug = !!opts.debug;\r\n\r\n    const wasmModule = await loadWasmModule();\r\n\r\n    // For web target, default init is usually a function that fetches/instantiates wasm.\r\n    // For nodejs target, it's typically not needed (sync require loads wasm).\r\n    if (typeof wasmModule.default === \"function\") {\r\n      await (wasmModule.default as () => Promise<void>)();\r\n    }\r\n\r\n    wasmModule.init(debug);\r\n    const converter = new wasmModule.Converter(debug);\r\n\r\n    if (debug) console.log(\"[convert-buddy-js] initialized with debug logging\");\r\n    return new ConvertBuddy(converter, debug);\r\n  }\r\n\r\n  push(chunk: Uint8Array): Uint8Array {\r\n    if (this.debug) console.log(\"[convert-buddy-js] push\", chunk.byteLength);\r\n    return this.converter.push(chunk);\r\n  }\r\n\r\n  finish(): Uint8Array {\r\n    if (this.debug) console.log(\"[convert-buddy-js] finish\");\r\n    return this.converter.finish();\r\n  }\r\n}\r\n"],"mappings":";AAaA,eAAe,iBAAsC;AAEnD,QAAM,SACJ,OAAO,YAAY,eACnB,CAAC,CAAE,QAAgB,UAAU;AAE/B,MAAI,QAAQ;AAEV,UAAM,EAAE,cAAc,IAAI,MAAM,OAAO,QAAa;AACpD,UAAMA,WAAU,cAAc,YAAY,GAAG;AAE7C,UAAMC,OAAMD,SAAQ,kBAAkB;AACtC,WAAOC;AAAA,EACT;AAGA,QAAM,MAAO,MAAM,OAAO,8BAA8B;AACxD,SAAO;AACT;AAEO,IAAM,eAAN,MAAM,cAAa;AAAA,EAChB;AAAA,EACA;AAAA,EAEA,YAAY,WAAgB,OAAgB;AAClD,SAAK,YAAY;AACjB,SAAK,QAAQ;AAAA,EACf;AAAA,EAEA,aAAa,OAAO,OAA4B,CAAC,GAA0B;AACzE,UAAM,QAAQ,CAAC,CAAC,KAAK;AAErB,UAAM,aAAa,MAAM,eAAe;AAIxC,QAAI,OAAO,WAAW,YAAY,YAAY;AAC5C,YAAO,WAAW,QAAgC;AAAA,IACpD;AAEA,eAAW,KAAK,KAAK;AACrB,UAAM,YAAY,IAAI,WAAW,UAAU,KAAK;AAEhD,QAAI,MAAO,SAAQ,IAAI,mDAAmD;AAC1E,WAAO,IAAI,cAAa,WAAW,KAAK;AAAA,EAC1C;AAAA,EAEA,KAAK,OAA+B;AAClC,QAAI,KAAK,MAAO,SAAQ,IAAI,2BAA2B,MAAM,UAAU;AACvE,WAAO,KAAK,UAAU,KAAK,KAAK;AAAA,EAClC;AAAA,EAEA,SAAqB;AACnB,QAAI,KAAK,MAAO,SAAQ,IAAI,2BAA2B;AACvD,WAAO,KAAK,UAAU,OAAO;AAAA,EAC/B;AACF;","names":["require","mod"]}